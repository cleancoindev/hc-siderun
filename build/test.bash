#!/bin/bash

# 1 - execute all unit tests
# 2 - concatonate all source files into the main executable script
# 3 - execute all integration tests

# make bash a little more strict / deterministic
set -Eeuo pipefail

_SRT_DIR=$( dirname $( n=${0}; while nn=$( readlink -n "$n" ); do n=$nn; done; echo "$n" ))
_SRT_GIT_HASH="$(git rev-parse --short HEAD)"

function _sr_test_exec {
  local _FIND_DIR="${1}"
  local _TMP_STATS=$(mktemp)

  for _TEST in $(find "${_FIND_DIR}" -iname "*.test.bash"); do
    /bin/bash "${_SRT_DIR}/test-helper.bash" "${_TMP_STATS}" "${_TEST}" || true
  done

  local _TOTAL=$(grep -c -e "^ok" -e "^not ok" ${_TMP_STATS})
  local _PASS=$(grep -c -e "^ok" ${_TMP_STATS})
  local _FAIL=$(grep -c -e "^not ok" ${_TMP_STATS})

  echo
  echo "--- begin tap output --"
  echo "1..${_TOTAL}"
  cat ${_TMP_STATS}
  echo
  echo "# Total: ${_TOTAL}"
  echo "#  Pass: ${_PASS}"
  echo "#  Fail: ${_FAIL}"
  echo "--- end tap output --"

  rm ${_TMP_STATS}

  if [ ${_FAIL} -gt 0 ]; then
    echo "failed tests, exiting with code 1" 1>&2
    exit 1
  fi
}

# -- step 1 - execute unit tests -- #

_sr_test_exec "${_SRT_DIR}/../src"

# -- step 2 - build the single bin script -- #

function _sr_build_hc_siderun {
  _SRT_BIN="${_SRT_DIR}/../bin/hc-siderun"
  echo
  echo "Building ${_SRT_BIN}" 1>&2
  cat << EOF > "${_SRT_BIN}"
#!/bin/bash

# AUTO-GENERATED by build/test.bash - do not edit directly

# make bash a little more strict / deterministic
set -Eeuo pipefail

_SR_VERSION_GIT="${_SRT_GIT_HASH}"

# -- begin source files -- #

EOF

  chmod a+x "${_SRT_BIN}"

  # loop over manifest, adding to the binary
  while read -r SCRIPT; do
    echo $'
###########################################################################
# '"${SCRIPT}"$'
###########################################################################
' >> "${_SRT_BIN}"
    cat "${_SRT_DIR}/../src/${SCRIPT}" >> "${_SRT_BIN}"
  done < "${_SRT_DIR}/../src/MANIFEST"

  # add the actual entrypoint call
  cat << EOF >> "${_SRT_BIN}"

# entrypoint
_sr_main "\${@}"
EOF

  echo "Built ${_SRT_BIN}" 1>&2
}

_sr_build_hc_siderun

# -- step 3 - execute integration tests -- #

_sr_test_exec "${_SRT_DIR}/integration"
